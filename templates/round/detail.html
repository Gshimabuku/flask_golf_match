{% extends "base.html" %}

{% block title %}ラウンド詳細{% endblock %}

{% block body_class %}round-detail-page{% endblock %}

{% block header %}
{% set header_title = "ラウンド詳細" %}
{% include '_header.html' %}
{% endblock %}

{% block content %}

        <!-- ページ固有アクション -->
        <div class="page-actions">
            <button type="button" class="action-btn" id="edit-btn">編集</button>
            <button type="button" class="action-btn" id="delete-btn" style="background-color: #f44336;">削除</button>
        </div>

        <!-- ラウンド基本情報 -->
        <div class="round-info-card">
            <div class="round-header">
                <div class="round-title">{{ round.course_name }}</div>
                <div class="round-date-display">{{ round.play_date }}</div>
            </div>
            <div class="round-members-display">
                {% for member in round.members %}
                <span class="member-badge">{{ member }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- スコア詳細セクション -->
        <div class="score-section">
            <h2 class="section-title">スコア詳細</h2>
            
            <!-- INとOUTを縦並びで表示 -->
            <div class="score-tables-wrapper" style="flex-direction: column;">
                <!-- OUTのスコア -->
                <div class="score-table-container">
                    <div class="score-table-header">OUT</div>
                    <div class="score-table-scroll">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th class="player-col">Player</th>
                                    {% for hole in range(1, 10) %}
                                    <th>{{ hole }}</th>
                                    {% endfor %}
                                    <th class="total-col">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="par-row">
                                    <td class="player-col">Par</td>
                                    {% for hole in range(1, 10) %}
                                    <td>{{ pars_out[hole-1] if pars_out and hole-1 < pars_out|length else 3 }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ par_out_total }}</td>
                                </tr>
                                {% for player_name, player_scores in scores.items() %}
                                <!-- スコア行 -->
                                <tr>
                                    <td class="player-col">{{ player_name }}</td>
                                    {% set out_total = namespace(value=0) %}
                                    {% for hole in range(1, 10) %}
                                    {% set stroke = player_scores.get(hole, {}).get('stroke', 0) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set total = stroke + putt %}
                                    {% set par = pars_out[hole-1] if pars_out and hole-1 < pars_out|length else 3 %}
                                    {% set out_total.value = out_total.value + total %}
                                    <td{% if total > 0 and total < par %} class="score-birdie"{% endif %}>{{ stroke if stroke > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ out_total.value if out_total.value > 0 else '-' }}</td>
                                </tr>
                                <!-- パット行 -->
                                <tr class="putt-row">
                                    <td class="player-col" style="font-size: 0.9em; color: #666;">Putt</td>
                                    {% set out_putt_total = namespace(value=0) %}
                                    {% for hole in range(1, 10) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set out_putt_total.value = out_putt_total.value + putt %}
                                    <td style="font-size: 0.9em; color: #666;">{{ putt if putt > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col" style="font-size: 0.9em;">{{ out_putt_total.value if out_putt_total.value > 0 else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- INのスコア -->
                <div class="score-table-container">
                    <div class="score-table-header">IN</div>
                    <div class="score-table-scroll">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th class="player-col">Player</th>
                                    {% for hole in range(10, 19) %}
                                    <th>{{ hole }}</th>
                                    {% endfor %}
                                    <th class="total-col">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="par-row">
                                    <td class="player-col">Par</td>
                                    {% for hole in range(10, 19) %}
                                    <td>{{ pars_in[hole-10] if pars_in and hole-10 < pars_in|length else 3 }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ par_in_total }}</td>
                                </tr>
                                {% for player_name, player_scores in scores.items() %}
                                <!-- スコア行 -->
                                <tr>
                                    <td class="player-col">{{ player_name }}</td>
                                    {% set in_total = namespace(value=0) %}
                                    {% for hole in range(10, 19) %}
                                    {% set stroke = player_scores.get(hole, {}).get('stroke', 0) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set total = stroke + putt %}
                                    {% set par = pars_in[hole-10] if pars_in and hole-10 < pars_in|length else 3 %}
                                    {% set in_total.value = in_total.value + total %}
                                    <td{% if total > 0 and total < par %} class="score-birdie"{% endif %}>{{ stroke if stroke > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ in_total.value if in_total.value > 0 else '-' }}</td>
                                </tr>
                                <!-- パット行 -->
                                <tr class="putt-row">
                                    <td class="player-col" style="padding-left: 24px; font-size: 0.9em; color: #666;">Putt</td>
                                    {% set in_putt_total = namespace(value=0) %}
                                    {% for hole in range(10, 19) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set in_putt_total.value = in_putt_total.value + putt %}
                                    <td style="font-size: 0.9em; color: #666;">{{ putt if putt > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col" style="font-size: 0.9em;">{{ in_putt_total.value if in_putt_total.value > 0 else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 合計スコアサマリー -->
            <div class="score-summary">
                <h3 class="summary-title">合計スコア</h3>
                <div class="summary-table-wrapper">
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th class="player-col">Player</th>
                                <th>OUT</th>
                                <th>IN</th>
                                <th class="total-col">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for player_name, player_scores in scores.items() %}
                            {% set out_total = namespace(value=0) %}
                            {% set in_total = namespace(value=0) %}
                            {% for hole in range(1, 10) %}
                                {% set out_total.value = out_total.value + player_scores.get(hole, {}).get('total', 0) %}
                            {% endfor %}
                            {% for hole in range(10, 19) %}
                                {% set in_total.value = in_total.value + player_scores.get(hole, {}).get('total', 0) %}
                            {% endfor %}
                            <tr>
                                <td class="player-col">{{ player_name }}</td>
                                <td>{{ out_total.value if out_total.value > 0 else '-' }}</td>
                                <td>{{ in_total.value if in_total.value > 0 else '-' }}</td>
                                <td class="total-col">{{ (out_total.value + in_total.value) if (out_total.value + in_total.value) > 0 else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if game_setting %}
        <!-- ゲーム結果セクション -->
        <div class="game-results-section">
            <h2 class="section-title">ゲーム結果</h2>
            
            {% if game_setting.gold %}
            <!-- オリンピック結果 -->
            <div class="game-result-card">
                <h3 class="game-result-title">オリンピック</h3>
                <p>※オリンピック結果の表示は今後実装予定</p>
            </div>
            {% endif %}

            {% if game_setting.snake %}
            <!-- ヘビ結果 -->
            <div class="game-result-card">
                <h3 class="game-result-title">ヘビ（レート: {{ game_setting.snake_rate if game_setting.snake_rate else 100 }}円）</h3>
                <p>※ヘビ結果の表示は今後実装予定</p>
            </div>
            {% endif %}

            {% if game_setting.nearpin %}
            <!-- ニアピン結果 -->
            <div class="game-result-card">
                <h3 class="game-result-title">ニアピン（レート: {{ game_setting.nearpin_rate if game_setting.nearpin_rate else 100 }}円）</h3>
                <p>※ニアピン結果の表示は今後実装予定</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

{% endblock %}

{% block scripts %}
<script>
    // 戻るボタンの処理
    document.addEventListener('header-back-clicked', function () {
        location.href = '{{ url_for("round_list") }}';
    });
    
    // 編集ボタンの処理
    document.getElementById('edit-btn').addEventListener('click', function() {
        location.href = '{{ url_for("round_hole", round_id=round.page_id, hole_number=1) }}';
    });
    
    // 削除ボタンの処理
    document.getElementById('delete-btn').addEventListener('click', function() {
        if (confirm('このラウンドとすべての関連データ（スコア、ゲーム設定）を削除しますか？\nこの操作は取り消せません。')) {
            // ローディングオーバーレイを表示
            showLoading('削除中...');
            
            // サーバーに削除リクエストを送信
            fetch('{{ url_for("round_delete", round_id=round.page_id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.status === 'success') {
                    alert(data.message);
                    location.href = '{{ url_for("round_list") }}';
                } else {
                    alert('エラー: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                alert('削除中にエラーが発生しました: ' + error);
            });
        }
    });
</script>
{% endblock %}
