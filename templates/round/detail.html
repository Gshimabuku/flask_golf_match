{% extends "base.html" %}

{% block title %}ラウンド詳細{% endblock %}

{% block body_class %}round-detail-page{% endblock %}

{% block header %}
{% set header_title = "ラウンド詳細" %}
{% include '_header.html' %}
{% endblock %}

{% block content %}

        <!-- ページ固有アクション -->
        <div class="page-actions">
            <button type="button" class="action-btn" id="edit-btn">編集</button>
            <button type="button" class="action-btn" id="delete-btn" style="background-color: #f44336;">削除</button>
        </div>

        <!-- ラウンド基本情報 -->
        <div class="round-info-card">
            <div class="round-header">
                <div class="round-title">{{ round.course_name }}</div>
                <div class="round-date-display">{{ round.play_date }}</div>
            </div>
            <div class="round-members-display">
                {% for member in round.members %}
                <span class="member-badge">{{ member }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- スコア詳細セクション -->
        <div class="score-section">
            <h2 class="section-title">スコア詳細</h2>
            
            <!-- INとOUTを縦並びで表示 -->
            <div class="score-tables-wrapper" style="flex-direction: column;">
                <!-- OUTのスコア -->
                <div class="score-table-container">
                    <div class="score-table-header">OUT</div>
                    <div class="score-table-scroll">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th class="player-col">Player</th>
                                    {% for hole in range(1, 10) %}
                                    <th>{{ hole }}</th>
                                    {% endfor %}
                                    <th class="total-col">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="par-row">
                                    <td class="player-col">Par</td>
                                    {% for hole in range(1, 10) %}
                                    <td>{{ pars_out[hole-1] if pars_out and hole-1 < pars_out|length else 3 }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ par_out_total }}</td>
                                </tr>
                                {% for player_name, player_scores in scores %}
                                <!-- スコア行 -->
                                <tr>
                                    <td class="player-col">{{ player_name }}</td>
                                    {% set out_total = namespace(value=0) %}
                                    {% for hole in range(1, 10) %}
                                    {% set stroke = player_scores.get(hole, {}).get('stroke', 0) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set par = pars_out[hole-1] if pars_out and hole-1 < pars_out|length else 3 %}
                                    {% set out_total.value = out_total.value + stroke %}
                                    <td{% if stroke > 0 and stroke < par %} class="score-birdie"{% endif %}>{{ stroke if stroke > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ out_total.value if out_total.value > 0 else '-' }}</td>
                                </tr>
                                <!-- パット行 -->
                                <tr class="putt-row">
                                    <td class="player-col" style="font-size: 0.9em; color: #666;">Putt</td>
                                    {% set out_putt_total = namespace(value=0) %}
                                    {% for hole in range(1, 10) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set out_putt_total.value = out_putt_total.value + putt %}
                                    <td style="font-size: 0.9em; color: #666;">{{ putt if putt > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col" style="font-size: 0.9em;">{{ out_putt_total.value if out_putt_total.value > 0 else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- INのスコア -->
                <div class="score-table-container">
                    <div class="score-table-header">IN</div>
                    <div class="score-table-scroll">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th class="player-col">Player</th>
                                    {% for hole in range(10, 19) %}
                                    <th>{{ hole }}</th>
                                    {% endfor %}
                                    <th class="total-col">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="par-row">
                                    <td class="player-col">Par</td>
                                    {% for hole in range(10, 19) %}
                                    <td>{{ pars_in[hole-10] if pars_in and hole-10 < pars_in|length else 3 }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ par_in_total }}</td>
                                </tr>
                                {% for player_name, player_scores in scores %}
                                <!-- スコア行 -->
                                <tr>
                                    <td class="player-col">{{ player_name }}</td>
                                    {% set in_total = namespace(value=0) %}
                                    {% for hole in range(10, 19) %}
                                    {% set stroke = player_scores.get(hole, {}).get('stroke', 0) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set par = pars_in[hole-10] if pars_in and hole-10 < pars_in|length else 3 %}
                                    {% set in_total.value = in_total.value + stroke %}
                                    <td{% if stroke > 0 and stroke < par %} class="score-birdie"{% endif %}>{{ stroke if stroke > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ in_total.value if in_total.value > 0 else '-' }}</td>
                                </tr>
                                <!-- パット行 -->
                                <tr class="putt-row">
                                    <td class="player-col" style="font-size: 0.9em; color: #666;">Putt</td>
                                    {% set in_putt_total = namespace(value=0) %}
                                    {% for hole in range(10, 19) %}
                                    {% set putt = player_scores.get(hole, {}).get('putt', 0) %}
                                    {% set in_putt_total.value = in_putt_total.value + putt %}
                                    <td style="font-size: 0.9em; color: #666;">{{ putt if putt > 0 else '-' }}</td>
                                    {% endfor %}
                                    <td class="total-col" style="font-size: 0.9em;">{{ in_putt_total.value if in_putt_total.value > 0 else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 合計スコアサマリー -->
            <div class="score-summary">
                <h3 class="summary-title">合計スコア</h3>
                <div class="summary-table-wrapper">
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th class="player-col">Player</th>
                                <th>OUT</th>
                                <th>IN</th>
                                <th class="total-col">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for player_name, player_scores in scores %}
                            {% set out_total = namespace(value=0) %}
                            {% set in_total = namespace(value=0) %}
                            {% set out_putt_total = namespace(value=0) %}
                            {% set in_putt_total = namespace(value=0) %}
                            {% for hole in range(1, 10) %}
                                {% set out_total.value = out_total.value + player_scores.get(hole, {}).get('stroke', 0) %}
                                {% set out_putt_total.value = out_putt_total.value + player_scores.get(hole, {}).get('putt', 0) %}
                            {% endfor %}
                            {% for hole in range(10, 19) %}
                                {% set in_total.value = in_total.value + player_scores.get(hole, {}).get('stroke', 0) %}
                                {% set in_putt_total.value = in_putt_total.value + player_scores.get(hole, {}).get('putt', 0) %}
                            {% endfor %}
                            {% set total_score = out_total.value + in_total.value %}
                            {% set total_putt = out_putt_total.value + in_putt_total.value %}
                            <tr>
                                <td class="player-col">{{ player_name }}</td>
                                <td>{{ out_total.value if out_total.value > 0 else '-' }}</td>
                                <td>{{ in_total.value if in_total.value > 0 else '-' }}</td>
                                <td class="total-col">
                                    {% if total_score > 0 %}
                                    <span style="font-size: 1.2em; font-weight: bold;">{{ total_score }}</span><span style="font-size: 0.9em;">({{ total_putt }})</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if game_setting %}
        <!-- ゲーム結果セクション -->
        <div class="game-results-section">
            <h2 class="section-title">ゲーム結果</h2>
            
            {% if game_setting.gold %}
            <!-- オリンピック結果 -->
            <div class="game-result-card">
                <h3 class="game-result-title">オリンピック</h3>
                {% if olympic_results %}
                <div class="olympic-tables-wrapper">
                    <!-- OUTのオリンピック -->
                    <div class="olympic-table-container">
                        <div class="olympic-table-header">OUT</div>
                        <div class="olympic-table-scroll">
                            <table class="olympic-table">
                                <thead>
                                    <tr>
                                        <th class="player-col">Player</th>
                                        {% for hole in range(1, 10) %}
                                        <th>{{ hole }}</th>
                                        {% endfor %}
                                        <th class="total-col">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player_name, hole_points in olympic_results %}
                                    <tr>
                                        <td class="player-col">{{ player_name }}</td>
                                        {% set out_total = namespace(value=0) %}
                                        {% for hole in range(1, 10) %}
                                        {% set points = hole_points.get(hole, 0) %}
                                        {% set out_total.value = out_total.value + points %}
                                        <td{% if points == (game_setting.diamond or 5) %} class="medal-diamond"{% elif points == (game_setting.gold or 3) %} class="medal-gold"{% elif points == (game_setting.silver or 2) %} class="medal-silver"{% elif points == (game_setting.bronze or 1) %} class="medal-bronze"{% elif points == (game_setting.iron or 0) %} class="medal-iron"{% endif %}>{{ points if points > 0 else '0' }}</td>
                                        {% endfor %}
                                        <td class="total-col">{{ out_total.value }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- INのオリンピック -->
                    <div class="olympic-table-container">
                        <div class="olympic-table-header">IN</div>
                        <div class="olympic-table-scroll">
                            <table class="olympic-table">
                                <thead>
                                    <tr>
                                        <th class="player-col">Player</th>
                                        {% for hole in range(10, 19) %}
                                        <th>{{ hole }}</th>
                                        {% endfor %}
                                        <th class="total-col">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player_name, hole_points in olympic_results %}
                                    <tr>
                                        <td class="player-col">{{ player_name }}</td>
                                        {% set in_total = namespace(value=0) %}
                                        {% for hole in range(10, 19) %}
                                        {% set points = hole_points.get(hole, 0) %}
                                        {% set in_total.value = in_total.value + points %}
                                        <td{% if points == (game_setting.diamond or 5) %} class="medal-diamond"{% elif points == (game_setting.gold or 3) %} class="medal-gold"{% elif points == (game_setting.silver or 2) %} class="medal-silver"{% elif points == (game_setting.bronze or 1) %} class="medal-bronze"{% elif points == (game_setting.iron or 0) %} class="medal-iron"{% endif %}>{{ points if points > 0 else '0' }}</td>
                                        {% endfor %}
                                        <td class="total-col">{{ in_total.value }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- オリンピック合計 -->
                <div class="olympic-summary">
                    <h4 class="olympic-summary-title">合計スコア</h4>
                    <table class="olympic-summary-table">
                        <thead>
                            <tr>
                                <th class="player-col">Player</th>
                                <th>OUT</th>
                                <th>IN</th>
                                <th class="total-col">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for player_name, hole_points in olympic_results %}
                            {% set out_total = namespace(value=0) %}
                            {% set in_total = namespace(value=0) %}
                            {% for hole in range(1, 10) %}
                                {% set out_total.value = out_total.value + hole_points.get(hole, 0) %}
                            {% endfor %}
                            {% for hole in range(10, 19) %}
                                {% set in_total.value = in_total.value + hole_points.get(hole, 0) %}
                            {% endfor %}
                            <tr>
                                <td class="player-col">{{ player_name }}</td>
                                <td>{{ out_total.value }}</td>
                                <td>{{ in_total.value }}</td>
                                <td class="total-col">{{ out_total.value + in_total.value }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>オリンピック結果がありません</p>
                {% endif %}
            </div>
            {% endif %}

            {% if game_setting.snake %}
            <!-- ヘビ結果 -->
            <div class="game-result-card">
                <h3 class="game-result-title">ヘビ</h3>
                {% if snake_results and snake_results.hole_snakes %}
                <div class="snake-result-wrapper">
                    <div class="snake-table-scroll">
                        <table class="snake-table">
                            <thead>
                                <tr>
                                    <th>Hole</th>
                                    {% for hole in range(1, 19) %}
                                    <th>{{ hole }}</th>
                                    {% endfor %}
                                    <th class="total-col">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player_name, hole_snakes in snake_results.hole_snakes %}
                                <tr>
                                    <td class="label-col">{{ player_name }}</td>
                                    {% set total = namespace(value=0) %}
                                    {% for hole in range(1, 19) %}
                                    {% set snake_count = hole_snakes.get(hole, 0) %}
                                    {% set total.value = total.value + snake_count %}
                                    <td>{{ snake_count }}</td>
                                    {% endfor %}
                                    <td class="total-col">{{ total.value }}</td>
                                </tr>
                                {% endfor %}
                                <tr class="snake-out-row">
                                    <td class="label-col">OUT</td>
                                    {% for hole in range(1, 19) %}
                                    <td class="snake-out">{{ snake_results.hole_outs.get(hole, '-') }}</td>
                                    {% endfor %}
                                    <td class="total-col">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    {% if snake_results.three_hole_summary %}
                    <!-- ヘビ合計 -->
                    <div class="snake-summary">
                        <h4 class="snake-summary-title">3ホール清算</h4>
                        <table class="snake-summary-table">
                            <thead>
                                <tr>
                                    <th class="hole-range-col">ホール</th>
                                    <th>合計ヘビ</th>
                                    <th>OUT</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for summary in snake_results.three_hole_summary %}
                                <tr>
                                    <td class="hole-range-col">{{ summary.holes }}</td>
                                    <td>{{ summary.total_snakes }}</td>
                                    <td>{{ summary.out_player }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <h4 class="snake-summary-title" style="margin-top: 24px;">獲得合計</h4>
                        <table class="snake-summary-table">
                            <thead>
                                <tr>
                                    <th class="player-col">Player</th>
                                    <th>獲得ヘビ数</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player_name, gained in snake_results.total_gained %}
                                <tr>
                                    <td class="player-col">{{ player_name }}</td>
                                    <td class="total-gained">{{ gained }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p>ヘビ結果がありません</p>
                {% endif %}
            </div>
            {% endif %}

            {% if game_setting.nearpin %}
            <!-- ニアピン結果 -->
            <div class="game-result-card">
                <h3 class="game-result-title">ニアピン</h3>
                {% if nearpin_results %}
                <div class="nearpin-result-wrapper">
                    <table class="nearpin-table">
                        <thead>
                            <tr>
                                <th>Hole</th>
                                <th>獲得者</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for nearpin in nearpin_results %}
                            <tr>
                                <td class="hole-col">{{ nearpin.hole_number }}番（Par 3）</td>
                                <td>{{ nearpin.winner }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>Par 3のホールがありません</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}

{% endblock %}

{% block scripts %}
<script>
    // 戻るボタンの処理
    document.addEventListener('header-back-clicked', function () {
        location.href = '{{ url_for("round_list") }}';
    });
    
    // 編集ボタンの処理
    document.getElementById('edit-btn').addEventListener('click', function() {
        location.href = '{{ url_for("round_hole", round_id=round.page_id, hole_number=1) }}';
    });
    
    // 削除ボタンの処理
    document.getElementById('delete-btn').addEventListener('click', function() {
        if (confirm('このラウンドとすべての関連データ（スコア、ゲーム設定）を削除しますか？\nこの操作は取り消せません。')) {
            // ローディングオーバーレイを表示
            showLoading('削除中...');
            
            // サーバーに削除リクエストを送信
            fetch('{{ url_for("round_delete", round_id=round.page_id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.status === 'success') {
                    alert(data.message);
                    location.href = '{{ url_for("round_list") }}';
                } else {
                    alert('エラー: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                alert('削除中にエラーが発生しました: ' + error);
            });
        }
    });
</script>
{% endblock %}
