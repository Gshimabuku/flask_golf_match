<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ホールスコア入力</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="hole-page">
    <div class="container">
        <div class="hole-header">
            <h1>{{ round.get('name', 'ラウンド') }}</h1>
            <div class="hole-info">
                <div class="hole-number">HOLE {{ hole_number }}</div>
                <div class="par-info">PAR 4</div>
            </div>
        </div>

        <!-- ホール間移動ボタン -->
        <div class="navigation-buttons">
            <a href="{{ url_for('round_hole', round_id=round['page_id'], hole_number=hole_number-1) if hole_number > 1 else '#' }}" 
               class="nav-btn {{ 'disabled' if hole_number <= 1 else '' }}">
                ← 前のホール
            </a>
            <a href="{{ url_for('round_hole', round_id=round['page_id'], hole_number=hole_number+1) if hole_number < 18 else '#' }}" 
               class="nav-btn {{ 'disabled' if hole_number >= 18 else '' }}">
                次のホール →
            </a>
        </div>

        <!-- メンバータブ -->
        <div class="member-tabs">
            {% for member in members %}
            <button type="button" class="tab-btn {{ 'active' if loop.index == 1 else '' }}" data-member="{{ loop.index }}">
                {{ member.display_name }}
            </button>
            {% endfor %}
        </div>

        <form action="{{ url_for('round_hole_save', round_id=round['page_id'], hole_number=hole_number) }}" method="POST" class="score-form">
            {% for member in members %}
            {% set member_idx = loop.index %}
            {% set existing = existing_scores.get(member.page_id, {}) %}
            
            <!-- メンバー{{ member_idx }} -->
            <div class="member-content {{ 'active' if loop.index == 1 else '' }}" data-member="{{ member_idx }}">
                <div class="member-name-display">{{ member.display_name }}</div>
                
                <input type="hidden" name="member_id[]" value="{{ member.page_id }}">
                
                <div class="score-inputs">
                    <div class="input-group">
                        <label for="stroke_{{ member_idx }}">ストローク</label>
                        <div class="input-controls">
                            <button type="button" class="minus-btn" data-target="stroke_{{ member_idx }}">−</button>
                            <input type="number" 
                                   id="stroke_{{ member_idx }}" 
                                   name="stroke_{{ member_idx }}" 
                                   min="1" 
                                   max="15"
                                   value="{{ existing.stroke or 4 }}"
                                   readonly>
                            <button type="button" class="plus-btn" data-target="stroke_{{ member_idx }}">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="putt_{{ member_idx }}">パット</label>
                        <div class="input-controls">
                            <button type="button" class="minus-btn" data-target="putt_{{ member_idx }}">−</button>
                            <input type="number" 
                                   id="putt_{{ member_idx }}" 
                                   name="putt_{{ member_idx }}" 
                                   min="0" 
                                   max="3"
                                   value="{{ existing.putt or 0 }}"
                                   readonly>
                            <button type="button" class="plus-btn" data-target="putt_{{ member_idx }}">+</button>
                        </div>
                    </div>
                </div>

                <!-- ゲームスコア -->
                <div class="game-scores">
                    <div class="game-score-item">
                        <label for="olympic_{{ member_idx }}">オリンピック</label>
                        <select id="olympic_{{ member_idx }}" name="olympic_{{ member_idx }}">
                            <option value="">なし</option>
                            {% for value, display_name in olympic_types %}
                            <option value="{{ value }}" {{ 'selected' if existing.olympic == value else '' }}>{{ display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="game-score-item">
                        <label for="snake_{{ member_idx }}">ヘビ</label>
                        <div class="snake-controls">
                            <div class="input-controls">
                                <button type="button" class="minus-btn small" data-target="snake_{{ member_idx }}">−</button>
                                <input type="number" 
                                       id="snake_{{ member_idx }}" 
                                       name="snake_{{ member_idx }}" 
                                       min="0" 
                                       max="99"
                                       value="{{ existing.snake or 0 }}"
                                       readonly>
                                <button type="button" class="plus-btn small" data-target="snake_{{ member_idx }}">+</button>
                            </div>
                            <label class="checkbox-label">
                                <span>アウト</span>
                                <input type="checkbox" id="snake_out_{{ member_idx }}" name="snake_out_{{ member_idx }}" {{ 'checked' if existing.snake_out else '' }}>
                            </label>
                        </div>
                    </div>

                    <div class="game-score-item">
                        <label class="checkbox-label nearpin-checkbox">
                            <span>ニアピン</span>
                            <input type="checkbox" id="nearpin_{{ member_idx }}" name="nearpin_{{ member_idx }}" {{ 'checked' if existing.nearpin else '' }}>
                        </label>
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="button-group">
                <button type="submit" class="btn btn-primary">
                    保存
                </button>
            </div>
        </form>
    </div>

    <script>
        // タブ切り替え機能
        document.querySelectorAll('.tab-btn').forEach(tab => {
            tab.addEventListener('click', function() {
                const memberId = this.dataset.member;
                
                // タブのアクティブ状態を切り替え
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // コンテンツの表示を切り替え
                document.querySelectorAll('.member-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.member-content[data-member="${memberId}"]`).classList.add('active');
            });
        });

        // プラス・マイナスボタンの機能
        document.querySelectorAll('.plus-btn, .minus-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const input = document.getElementById(targetId);
                const min = parseInt(input.min);
                const max = parseInt(input.max);
                let value = parseInt(input.value) || min;
                
                if (this.classList.contains('plus-btn')) {
                    if (value < max) {
                        input.value = value + 1;
                    }
                } else {
                    // マイナスボタン
                    if (value > min) {
                        // パットで値が0の場合は変更しない
                        if (targetId.includes('putt') && value === 0) {
                            return;
                        }
                        input.value = value - 1;
                    }
                }
                
                // ストロークとパットの整合性チェック
                validateStrokePutt(targetId);
            });
        });

        // ストロークとパットの整合性を保つ関数
        function validateStrokePutt(changedInputId) {
            const memberNum = changedInputId.match(/\d+/)[0];
            const strokeInput = document.getElementById(`stroke_${memberNum}`);
            const puttInput = document.getElementById(`putt_${memberNum}`);
            
            let stroke = parseInt(strokeInput.value) || 0;
            let putt = parseInt(puttInput.value) || 0;
            
            if (changedInputId.includes('stroke')) {
                // ストロークが変更された場合
                if (stroke > 0 && putt >= stroke) {
                    // パットがストローク以上の場合、パットを1減らす
                    puttInput.value = Math.max(0, stroke - 1);
                }
                // パットの最大値を更新
                puttInput.max = Math.max(0, stroke - 1);
            } else if (changedInputId.includes('putt')) {
                // パットが変更された場合
                if (putt > 0 && putt >= stroke) {
                    // パットがストローク以上の場合、ストロークを調整
                    strokeInput.value = putt + 1;
                    stroke = putt + 1;
                    // パットの最大値を更新
                    puttInput.max = Math.max(0, stroke - 1);
                }
            }
        }

        // 直接入力時の整合性チェック
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                validateStrokePutt(this.id);
            });
            
            input.addEventListener('change', function() {
                validateStrokePutt(this.id);
            });
        });

        // フォーカス時に入力値を選択
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('focus', function() {
                this.select();
            });
        });

        // Enterキーで次の入力フィールドへ移動（同じメンバー内）
        document.querySelectorAll('.member-content').forEach(member => {
            const inputs = member.querySelectorAll('input[type="number"]');
            inputs.forEach((input, index) => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextIndex = index + 1;
                        if (nextIndex < inputs.length) {
                            inputs[nextIndex].focus();
                        }
                    }
                });
            });
        });
    </script>
</body>

</html>
