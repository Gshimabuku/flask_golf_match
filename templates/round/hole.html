{% extends "base.html" %}

{% block title %}ホールスコア入力{% endblock %}

{% block body_class %}hole-page{% endblock %}

{% block header %}
{% set header_title = "スコア入力" %}
{% include '_header.html' %}
{% endblock %}

{% block content %}

        <!-- ホール情報 -->
        <div class="hole-info-section">
            <div class="hole-info">
                <div class="hole-number">HOLE {{ hole_number }}</div>
                <div class="par-info">PAR {{ hole_par }}</div>
            </div>
            <button type="button" class="action-btn" id="round-setting-button">ラウンド設定</button>
        </div>

        <!-- ホール間移動ボタン -->
        <div class="navigation-buttons">
            <button type="button" 
                    class="nav-btn nav-prev {{ 'disabled' if hole_number <= 1 else '' }}"
                    data-hole="{{ hole_number - 1 }}"
                    {{ 'disabled' if hole_number <= 1 else '' }}>
                ← 前のホール
            </button>
            <button type="button" 
                    class="nav-btn nav-next {{ 'disabled' if hole_number >= 18 else '' }}"
                    data-hole="{{ hole_number + 1 }}"
                    {{ 'disabled' if hole_number >= 18 else '' }}>
                次のホール →
            </button>
        </div>

        <!-- 大項目タブ -->
        <div class="main-tabs">
            <button type="button" class="main-tab-btn active" data-main-tab="score">スコア</button>
            <button type="button" class="main-tab-btn" data-main-tab="game">ゲーム</button>
        </div>

        <!-- 小項目タブ（ゲームの場合のみ表示） -->
        <div class="sub-tabs" id="game-sub-tabs" style="display: none;">
            {% if game_setting %}
            {% if game_setting.gold is not none %}
            <button type="button" class="sub-tab-btn active" data-sub-tab="olympic">オリンピック</button>
            {% endif %}
            {% if game_setting.snake is not none %}
            <button type="button" class="sub-tab-btn" data-sub-tab="snake">ヘビ</button>
            {% endif %}
            {% if game_setting.nearpin %}
            <button type="button" class="sub-tab-btn" data-sub-tab="nearpin">ニアピン</button>
            {% endif %}
            {% endif %}
        </div>

        <form action="{{ url_for('round_hole_save', round_id=round['page_id'], hole_number=hole_number) }}" 
              method="POST" 
              class="score-form"
              data-round-id="{{ round['page_id'] }}"
              data-hole-number="{{ hole_number }}">
            
            <!-- スコアセクション -->
            <div class="score-section main-tab-content active" data-main-content="score">
                {% for member in members %}
                {% set member_idx = loop.index %}
                {% set existing = existing_scores.get(member.page_id, {}) %}
                <input type="hidden" name="member_id[]" value="{{ member.page_id }}" data-has-score="{{ 'true' if existing.stroke else 'false' }}">
                
                <!-- メンバー{{ member_idx }} スコア -->
                <div class="score-member-card">
                    <h3 class="score-member-name">{{ member.display_name }}</h3>
                    <div class="score-inputs">
                        <div class="input-labels">
                            <span class="input-label">Score</span>
                            <span class="input-label">Putts</span>
                        </div>
                        <div class="input-values">
                            <input type="number" id="stroke_{{ member_idx }}" name="stroke_{{ member_idx }}" min="1" max="15" value="{{ existing.stroke or 4 }}" readonly>
                            <input type="number" id="putt_{{ member_idx }}" name="putt_{{ member_idx }}" min="0" max="3" value="{{ existing.putt or 0 }}" readonly>
                        </div>
                        <div class="input-buttons">
                            <div class="button-column">
                                <button type="button" class="plus-btn" data-target="stroke_{{ member_idx }}">+</button>
                                <button type="button" class="minus-btn" data-target="stroke_{{ member_idx }}">−</button>
                            </div>
                            <div class="button-column">
                                <button type="button" class="plus-btn" data-target="putt_{{ member_idx }}">+</button>
                                <button type="button" class="minus-btn" data-target="putt_{{ member_idx }}">−</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- ゲームセクション -->
            <div class="game-section main-tab-content" data-main-content="game">
                {% if game_setting %}
                <!-- オリンピック小項目 -->
                {% if game_setting.gold is not none %}
                <div class="game-sub-section sub-tab-content active" data-sub-content="olympic">
                    {% for member in members %}
                    {% set member_idx = loop.index %}
                    {% set existing = existing_scores.get(member.page_id, {}) %}
                    {% if member.page_id in (game_setting.olympic_member or []) %}
                    <div class="game-member-card">
                        <h3 class="game-member-name">{{ member.display_name }}</h3>
                        <div class="game-score-item">
                            <select id="olympic_{{ member_idx }}" name="olympic_{{ member_idx }}">
                                <option value="">なし</option>
                                {% for value, display_name in olympic_types %}
                                <option value="{{ value }}" {{ 'selected' if existing.olympic == value else '' }}>{{ display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ヘビ小項目 -->
                {% if game_setting.snake is not none %}
                <div class="game-sub-section sub-tab-content" data-sub-content="snake">
                    {% for member in members %}
                    {% set member_idx = loop.index %}
                    {% set existing = existing_scores.get(member.page_id, {}) %}
                    {% if member.page_id in (game_setting.snake_member or []) %}
                    <div class="game-member-card">
                        <h3 class="game-member-name">{{ member.display_name }}</h3>
                        <div class="game-score-item">
                            <div class="snake-controls">
                                <div class="input-controls">
                                    <button type="button" class="plus-btn small" data-target="snake_{{ member_idx }}">+</button>
                                    <input type="number" id="snake_{{ member_idx }}" name="snake_{{ member_idx }}" min="0" max="99" value="{{ existing.snake or 0 }}" readonly>
                                    <button type="button" class="minus-btn small" data-target="snake_{{ member_idx }}">−</button>
                                </div>
                                <label class="checkbox-label">
                                    <span>アウト</span>
                                    <input type="checkbox" id="snake_out_{{ member_idx }}" name="snake_out_{{ member_idx }}" {{ 'checked' if existing.snake_out else '' }}>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ニアピン小項目 -->
                {% if game_setting.nearpin %}
                <div class="game-sub-section sub-tab-content" data-sub-content="nearpin">
                    {% for member in members %}
                    {% set member_idx = loop.index %}
                    {% set existing = existing_scores.get(member.page_id, {}) %}
                    {% if member.page_id in (game_setting.nearpin_member or []) %}
                    <div class="game-member-card">
                        <h3 class="game-member-name">{{ member.display_name }}</h3>
                        <div class="game-score-item">
                            <label class="checkbox-label nearpin-checkbox">
                                <span>ニアピン</span>
                                <input type="checkbox" id="nearpin_{{ member_idx }}" name="nearpin_{{ member_idx }}" {{ 'checked' if existing.nearpin else '' }}>
                            </label>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                {% endif %}
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary" id="save-button">
                    保存
                </button>
            </div>
        </form>
    </div>

    <script>
        // フォームからデータ属性を取得
        const form = document.querySelector('.score-form');
        const roundId = form.dataset.roundId;
        const currentHole = parseInt(form.dataset.holeNumber);

        // 初期データの保存と変更追跡
        const initialData = {};
        let hasChanges = false;
        let hasExistingScore = false;

        // 初期データを記録
        document.querySelectorAll('input[name="member_id[]"]').forEach(function(hiddenInput, index) {
            const memberNum = index + 1;
            const hasScore = hiddenInput.dataset.hasScore === 'true';
            
            if (hasScore) {
                hasExistingScore = true;
            }
            
            initialData[memberNum] = {
                stroke: document.getElementById(`stroke_${memberNum}`) ? document.getElementById(`stroke_${memberNum}`).value : '',
                putt: document.getElementById(`putt_${memberNum}`) ? document.getElementById(`putt_${memberNum}`).value : '',
                olympic: document.getElementById(`olympic_${memberNum}`) ? document.getElementById(`olympic_${memberNum}`).value : '',
                snake: document.getElementById(`snake_${memberNum}`) ? document.getElementById(`snake_${memberNum}`).value : '',
                snake_out: document.getElementById(`snake_out_${memberNum}`) ? document.getElementById(`snake_out_${memberNum}`).checked : false,
                nearpin: document.getElementById(`nearpin_${memberNum}`) ? document.getElementById(`nearpin_${memberNum}`).checked : false
            };
        });

        // 変更検知関数
        function checkForChanges() {
            hasChanges = false;
            document.querySelectorAll('input[name="member_id[]"]').forEach(function(hiddenInput, index) {
                const memberNum = index + 1;
                const current = {
                    stroke: document.getElementById(`stroke_${memberNum}`) ? document.getElementById(`stroke_${memberNum}`).value : '',
                    putt: document.getElementById(`putt_${memberNum}`) ? document.getElementById(`putt_${memberNum}`).value : '',
                    olympic: document.getElementById(`olympic_${memberNum}`) ? document.getElementById(`olympic_${memberNum}`).value : '',
                    snake: document.getElementById(`snake_${memberNum}`) ? document.getElementById(`snake_${memberNum}`).value : '',
                    snake_out: document.getElementById(`snake_out_${memberNum}`) ? document.getElementById(`snake_out_${memberNum}`).checked : false,
                    nearpin: document.getElementById(`nearpin_${memberNum}`) ? document.getElementById(`nearpin_${memberNum}`).checked : false
                };
                
                if (JSON.stringify(current) !== JSON.stringify(initialData[memberNum])) {
                    hasChanges = true;
                }
            });
        }

        // 全ての入力フィールドに変更検知を追加
        document.querySelectorAll('input, select').forEach(function(input) {
            input.addEventListener('change', checkForChanges);
            input.addEventListener('input', checkForChanges);
        });

        // 保存ボタンの処理
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            showLoading('保存中...');
            
            // 常に現在のホールで保存
            form.action = `/round/${roundId}/hole/${currentHole}/save`;
            form.submit();
        });

        // ホームボタンの処理
        document.getElementById('home-button').addEventListener('click', function() {
            if (confirm('ホームに戻りますか？\n保存していないデータは失われます。')) {
                window.location.href = '/home';
            }
        });

        // ラウンド設定ボタンの処理
        document.getElementById('round-setting-button').addEventListener('click', function() {
            alert('ラウンド設定画面は未実装です');
        });

        // ホール移動ボタンのイベントリスナー設定
        document.addEventListener('DOMContentLoaded', function() {
            // 前のホールボタン
            const prevBtn = document.querySelector('.nav-prev');
            if (prevBtn && !prevBtn.disabled) {
                prevBtn.addEventListener('click', function() {
                    const nextHole = parseInt(this.dataset.hole);
                    if (hasChanges) {
                        if (confirm('変更が保存されていません。\nこのまま移動しますか？')) {
                            window.location.href = `/round/${roundId}/hole/${nextHole}`;
                        }
                    } else {
                        window.location.href = `/round/${roundId}/hole/${nextHole}`;
                    }
                });
            }

            // 次のホールボタン
            const nextBtn = document.querySelector('.nav-next');
            if (nextBtn && !nextBtn.disabled) {
                nextBtn.addEventListener('click', function() {
                    const nextHole = parseInt(this.dataset.hole);
                    if (hasChanges) {
                        if (confirm('変更が保存されていません。\nこのまま移動しますか？')) {
                            window.location.href = `/round/${roundId}/hole/${nextHole}`;
                        }
                    } else {
                        window.location.href = `/round/${roundId}/hole/${nextHole}`;
                    }
                });
            }
        });

        // 大項目タブ切り替え機能
        document.querySelectorAll('.main-tab-btn').forEach(tab => {
            tab.addEventListener('click', function() {
                const mainTab = this.dataset.mainTab;
                
                // 大項目タブのアクティブ状態を切り替え
                document.querySelectorAll('.main-tab-btn').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // 大項目コンテンツの表示を切り替え
                document.querySelectorAll('.main-tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.main-tab-content[data-main-content="${mainTab}"]`).classList.add('active');
                
                // 小項目タブの表示/非表示
                const subTabs = document.getElementById('game-sub-tabs');
                if (mainTab === 'game') {
                    subTabs.style.display = 'flex';
                } else {
                    subTabs.style.display = 'none';
                }
            });
        });

        // 小項目タブ切り替え機能
        document.querySelectorAll('.sub-tab-btn').forEach(tab => {
            tab.addEventListener('click', function() {
                const subTab = this.dataset.subTab;
                
                // 小項目タブのアクティブ状態を切り替え
                document.querySelectorAll('.sub-tab-btn').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // 小項目コンテンツの表示を切り替え
                document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.sub-tab-content[data-sub-content="${subTab}"]`).classList.add('active');
            });
        });

        // プラス・マイナスボタンの機能
        document.querySelectorAll('.plus-btn, .minus-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const input = document.getElementById(targetId);
                const min = parseInt(input.min);
                const max = parseInt(input.max);
                let value = parseInt(input.value) || min;
                
                if (this.classList.contains('plus-btn')) {
                    if (value < max) {
                        input.value = value + 1;
                    }
                } else {
                    // マイナスボタン
                    if (value > min) {
                        // パットで値が0の場合は変更しない
                        if (targetId.includes('putt') && value === 0) {
                            return;
                        }
                        input.value = value - 1;
                    }
                }
                
                // ストロークとパットの整合性チェック
                validateStrokePutt(targetId);
            });
        });

        // ストロークとパットの整合性を保つ関数
        function validateStrokePutt(changedInputId) {
            const memberNum = changedInputId.match(/\d+/)[0];
            const strokeInput = document.getElementById(`stroke_${memberNum}`);
            const puttInput = document.getElementById(`putt_${memberNum}`);
            
            if (!strokeInput || !puttInput) return;
            
            let stroke = parseInt(strokeInput.value) || 0;
            let putt = parseInt(puttInput.value) || 0;
            
            if (changedInputId.includes('stroke')) {
                // ストロークが変更された場合
                if (stroke > 0 && putt >= stroke) {
                    // パットがストローク以上の場合、パットを1減らす
                    puttInput.value = Math.max(0, stroke - 1);
                }
                // パットの最大値を更新
                puttInput.max = Math.max(0, stroke - 1);
            } else if (changedInputId.includes('putt')) {
                // パットが変更された場合
                if (putt > 0 && putt >= stroke) {
                    // パットがストローク以上の場合、ストロークを調整
                    strokeInput.value = putt + 1;
                    stroke = putt + 1;
                    // パットの最大値を更新
                    puttInput.max = Math.max(0, stroke - 1);
                }
            }
        }

        // 直接入力時の整合性チェック
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                validateStrokePutt(this.id);
            });
            
            input.addEventListener('change', function() {
                validateStrokePutt(this.id);
            });
        });

        // フォーカス時に入力値を選択
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('focus', function() {
                this.select();
            });
        });
    </script>
{% endblock %}

{% block scripts %}
<script>
    // hole画面は確認ダイアログを表示する必要があるため、ハンバーガーメニューボタンを個別に処理
    document.getElementById('home-button').addEventListener('click', function () {
        if (confirm('ホームに戻りますか?\n保存していないデータは失われます。')) {
            window.location.href = '{{ url_for("home") }}';
        }
    });

    document.getElementById('new-round-button').addEventListener('click', function () {
        if (confirm('新規ラウンドを作成しますか?\n保存していないデータは失われます。')) {
            window.location.href = '{{ url_for("round_new") }}';
        }
    });

    document.getElementById('round-list-button').addEventListener('click', function () {
        if (confirm('過去ラウンド一覧に移動しますか?\n保存していないデータは失われます。')) {
            window.location.href = '{{ url_for("round_list") }}';
        }
    });

    document.getElementById('course-list-button').addEventListener('click', function () {
        if (confirm('コース一覧に移動しますか?\n保存していないデータは失われます。')) {
            window.location.href = '{{ url_for("course_list") }}';
        }
    });

    // 戻るボタンの処理
    document.addEventListener('header-back-clicked', function () {
        if (confirm('過去ラウンド一覧に戻りますか?\n保存していないデータは失われます。')) {
            window.location.href = '{{ url_for("round_list") }}';
        }
    });

    // ラウンド設定ボタンの処理
    const roundSettingButton = document.getElementById('round-setting-button');
    if (roundSettingButton) {
        roundSettingButton.addEventListener('click', function () {
            alert('ラウンド設定画面は未実装です');
        });
    }
</script>
{% endblock %}
