{% extends "base.html" %}

{% block title %}新規ラウンド作成{% endblock %}

{% block body_class %}round-new-page{% endblock %}

{% block header %}
{% set header_title = "新規ラウンド作成" %}
{% include '_header.html' %}
{% endblock %}

{% block content %}

        <form action="/round/create" method="POST" class="round-form">
            <!-- ラウンド設定 -->
            <div class="game-section">
                <h2 class="mid-title">ラウンド設定</h2>

                <!-- ラウンド日 -->
                <div class="form-section">
                    <div class="form-row">
                        <label for="play_date">ラウンド日:</label>
                        <input type="date" id="play_date" name="play_date" required>
                    </div>
                </div>

                <!-- コース情報 -->
                <div class="form-section">
                    <h2 class="section-title">コース情報</h2>
                    <div class="form-row">
                        <label for="course">コース:</label>
                        <select id="course" name="course" required>
                            <option value="">選択してください</option>
                            {% for course in courses %}
                            <option value="{{ course.page_id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row" id="layout_out_row" style="display: none;">
                        <label for="layout_out">OUT:</label>
                        <select id="layout_out" name="layout_out" required disabled>
                            <option value="">コースを選択してください</option>
                        </select>
                    </div>
                    <div class="form-row" id="layout_in_row" style="display: none;">
                        <label for="layout_in">IN:</label>
                        <select id="layout_in" name="layout_in" required disabled>
                            <option value="">コースを選択してください</option>
                        </select>
                    </div>
                </div>

                <!-- メンバー -->
                <div class="form-section">
                    <h2 class="section-title">メンバー</h2>
                    <div class="form-row">
                        <label for="member_count">人数:</label>
                        <select id="member_count" name="member_count" required>
                            <option value="">選択してください</option>
                            <option value="1">1人</option>
                            <option value="2">2人</option>
                            <option value="3">3人</option>
                            <option value="4">4人</option>
                        </select>
                    </div>

                    <div class="form-row" id="member1_row" style="display: none;">
                        <label for="member1">メンバー1:</label>
                        <select id="member1" name="member1" disabled>
                            <option value="">選択してください</option>
                            {% for user in users %}
                            <option value="{{ user.page_id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-row" id="member2_row" style="display: none;">
                        <label for="member2">メンバー2:</label>
                        <select id="member2" name="member2" disabled>
                            <option value="">選択してください</option>
                            {% for user in users %}
                            <option value="{{ user.page_id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-row" id="member3_row" style="display: none;">
                        <label for="member3">メンバー3:</label>
                        <select id="member3" name="member3" disabled>
                            <option value="">選択してください</option>
                            {% for user in users %}
                            <option value="{{ user.page_id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-row" id="member4_row" style="display: none;">
                        <label for="member4">メンバー4:</label>
                        <select id="member4" name="member4" disabled>
                            <option value="">選択してください</option>
                            {% for user in users %}
                            <option value="{{ user.page_id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- ゲーム -->
            <div class="game-section">
                <h2 class="mid-title">ゲーム設定</h2>

                <!-- オリンピック -->
                <div class="form-section">
                    <h2 class="section-title">
                        <label class="title-checkbox-label">
                            <input type="checkbox" id="olympic_toggle" name="olympic_toggle" value="1">
                            <span>オリンピック</span>
                        </label>
                    </h2>
                    <div id="olympic_content" style="display: none;">
                        {% for value, display_name in olympic_types %}
                        <div class="form-row">
                            <label for="{{ value }}">{{ display_name }}:</label>
                            <div class="rate-control">
                                <button type="button" id="{{ value }}_minus">−</button>
                                <input type="number" id="{{ value }}" name="{{ value }}" value="{% if value == 'gold' %}4{% elif value == 'silver' %}3{% elif value == 'bronze' %}2{% elif value == 'iron' %}1{% elif value == 'diamond' %}5{% endif %}" readonly>
                                <button type="button" id="{{ value }}_plus">＋</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- ヘビ -->
                <div class="form-section">
                    <h2 class="section-title">
                        <label class="title-checkbox-label">
                            <input type="checkbox" id="snake_toggle" name="snake_toggle" value="1">
                            <span>ヘビ</span>
                        </label>
                    </h2>
                    <div id="snake_content" style="display: none;">
                        <div class="form-row">
                            <label class="checkbox-label">
                                <input type="radio" name="snake" value="All" id="snake_all">
                                <span>All</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="snake" value="Separate" id="snake_separate">
                                <span>Separate</span>
                            </label>
                        </div>
                        
                        <div class="form-row">
                            <label for="snake_rate">レート:</label>
                            <div class="rate-control">
                                <button type="button" id="snake_rate_minus">−</button>
                                <input type="number" id="snake_rate" name="snake_rate" value="1" readonly>
                                <button type="button" id="snake_rate_plus">＋</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ニアピン -->
                <div class="form-section">
                    <h2 class="section-title">
                        <label class="title-checkbox-label">
                            <input type="checkbox" id="nearpin_toggle" name="nearpin_toggle" value="1">
                            <span>ニアピン</span>
                        </label>
                    </h2>
                    <div id="nearpin_content" style="display: none;">
                        <div class="form-row">
                            <label for="nearpin_rate">レート:</label>
                            <div class="rate-control">
                                <button type="button" id="nearpin_rate_minus">−</button>
                                <input type="number" id="nearpin_rate" name="nearpin_rate" value="5" readonly>
                                <button type="button" id="nearpin_rate_plus">＋</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 参加メンバー -->
                <div class="form-section">
                    <h2 class="section-title">参加メンバー</h2>
                    <div id="game_members_section" style="display: none;">
                        <div class="game-members-container">
                            <div class="game-member-item" id="olympic_members_row" style="display: none;">
                                <label class="game-label">オリンピック:</label>
                                <div id="olympic_members" class="members-inline"></div>
                            </div>
                            <div class="game-member-item" id="snake_members_row" style="display: none;">
                                <label class="game-label">ヘビ:</label>
                                <div id="snake_members" class="members-inline"></div>
                            </div>
                            <div class="game-member-item" id="nearpin_members_row" style="display: none;">
                                <label class="game-label">ニアピン:</label>
                                <div id="nearpin_members" class="members-inline"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <button type="submit" class="submit-btn">作成</button>
            </div>
        </form>
    </div>

    <script type="application/json" id="layout-data">{{ layouts | tojson }}</script>
    <script>
        // 参加メンバーセクションの表示/非表示を更新
        function updateGameMembersSection() {
            const olympicChecked = document.getElementById("olympic_toggle").checked;
            const snakeChecked = document.getElementById("snake_toggle").checked;
            const nearpinChecked = document.getElementById("nearpin_toggle").checked;

            const gameMembersSection = document.getElementById("game_members_section");
            const olympicRow = document.getElementById("olympic_members_row");
            const snakeRow = document.getElementById("snake_members_row");
            const nearpinRow = document.getElementById("nearpin_members_row");

            // いずれかのゲームがチェックされている場合のみセクションを表示
            const anyGameChecked = olympicChecked || snakeChecked || nearpinChecked;
            gameMembersSection.style.display = anyGameChecked ? "block" : "none";

            // 各ゲームの行を表示/非表示
            olympicRow.style.display = olympicChecked ? "flex" : "none";
            snakeRow.style.display = snakeChecked ? "flex" : "none";
            nearpinRow.style.display = nearpinChecked ? "flex" : "none";

            updateGameMembers();
        }

        const layoutList = JSON.parse(document.getElementById('layout-data').textContent);
        const courseSelect = document.getElementById("course");
        const layoutInSelect = document.getElementById("layout_in");
        const layoutOutSelect = document.getElementById("layout_out");

        courseSelect.addEventListener("change", function () {
            const courseId = this.value;
            const layoutInSelect = document.getElementById("layout_in");
            const layoutOutSelect = document.getElementById("layout_out");
            const layoutInRow = document.getElementById("layout_in_row");
            const layoutOutRow = document.getElementById("layout_out_row");

            // プルダウンの初期化
            layoutInSelect.innerHTML = '<option value="">選択してください</option>';
            layoutOutSelect.innerHTML = '<option value="">選択してください</option>';

            if (courseId) {
                // レイアウト情報フィルター
                const filteredLayouts = layoutList.filter(
                    l => Array.isArray(l.course) && l.course.includes(courseId)
                );

                filteredLayouts.forEach(layout => {
                    // IN 用
                    const optIn = document.createElement("option");
                    optIn.value = layout.page_id;
                    optIn.textContent = layout.layout_name;
                    layoutInSelect.appendChild(optIn);

                    // OUT 用
                    const optOut = document.createElement("option");
                    optOut.value = layout.page_id;
                    optOut.textContent = layout.layout_name;
                    layoutOutSelect.appendChild(optOut);
                });

                // 表示して有効化
                layoutInRow.style.display = "flex";
                layoutOutRow.style.display = "flex";
                layoutInSelect.disabled = false;
                layoutOutSelect.disabled = false;
            } else {
                // 非表示にして無効化
                layoutInRow.style.display = "none";
                layoutOutRow.style.display = "none";
                layoutInSelect.disabled = true;
                layoutOutSelect.disabled = true;
                layoutInSelect.innerHTML = '<option value="">コースを選択してください</option>';
                layoutOutSelect.innerHTML = '<option value="">コースを選択してください</option>';
            }
        });

        // メンバー人数選択時の処理
        // (下部で定義されているため削除)

        // オリンピック表示切替
        document.getElementById("olympic_toggle").addEventListener("change", function () {
            const content = document.getElementById("olympic_content");
            content.style.display = this.checked ? "block" : "none";
            updateGameMembersSection();
        });

        // ヘビ表示切替
        document.getElementById("snake_toggle").addEventListener("change", function () {
            const content = document.getElementById("snake_content");
            content.style.display = this.checked ? "block" : "none";
            updateGameMembersSection();
        });

        // ニアピン表示切替
        document.getElementById("nearpin_toggle").addEventListener("change", function () {
            const content = document.getElementById("nearpin_content");
            content.style.display = this.checked ? "block" : "none";
            updateGameMembersSection();
        });

        // ゲーム参加メンバーの更新
        function updateGameMembers() {
            const memberSelects = [
                document.getElementById("member1"),
                document.getElementById("member2"),
                document.getElementById("member3"),
                document.getElementById("member4")
            ];

            const selectedMembers = [];
            memberSelects.forEach((select) => {
                if (!select.disabled && select.value) {
                    const selectedOption = select.options[select.selectedIndex];
                    selectedMembers.push({
                        value: select.value,
                        text: selectedOption.text
                    });
                }
            });

            // 各ゲームのメンバーチェックボックスを更新
            const games = ["olympic", "snake", "nearpin"];
            games.forEach((game) => {
                const container = document.getElementById(game + "_members");
                container.innerHTML = "";

                selectedMembers.forEach((member) => {
                    const label = document.createElement("label");
                    label.className = "checkbox-label";

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = game + "_member[]";
                    checkbox.value = member.value;
                    checkbox.checked = true;

                    const span = document.createElement("span");
                    span.textContent = member.text;

                    label.appendChild(checkbox);
                    label.appendChild(span);
                    container.appendChild(label);
                });
            });
        }

        // メンバー人数選択時の処理
        document.getElementById("member_count").addEventListener("change", function () {
            const count = parseInt(this.value);

            // 全メンバー行を取得
            const memberRows = [
                { row: document.getElementById("member1_row"), select: document.getElementById("member1") },
                { row: document.getElementById("member2_row"), select: document.getElementById("member2") },
                { row: document.getElementById("member3_row"), select: document.getElementById("member3") },
                { row: document.getElementById("member4_row"), select: document.getElementById("member4") }
            ];

            // 選択された人数分だけ表示
            memberRows.forEach((member, index) => {
                if (index < count) {
                    member.row.style.display = "flex";
                    member.select.disabled = false;
                    if (index === 0) {
                        member.select.required = true;
                    }
                } else {
                    member.row.style.display = "none";
                    member.select.disabled = true;
                    member.select.required = false;
                    member.select.value = "";
                }
            });

            updateGameMembers();
        });

        // メンバー選択変更時の処理
        ["member1", "member2", "member3", "member4"].forEach((memberId) => {
            document.getElementById(memberId).addEventListener("change", updateGameMembers);
        });

        // 数値入力の＋／−ボタン制御
        function setupNumberControl(id, step = 1) {
            const input = document.getElementById(id);
            document.getElementById(id + "_plus").addEventListener("click", () => {
                input.value = parseInt(input.value) + step;
            });
            document.getElementById(id + "_minus").addEventListener("click", () => {
                input.value = parseInt(input.value) - step;
            });
        }

        // 各項目に＋／−ボタンを設定
        setupNumberControl("gold");
        setupNumberControl("silver");
        setupNumberControl("bronze");
        setupNumberControl("iron");
        setupNumberControl("diamond");
        setupNumberControl("snake_rate");
        setupNumberControl("nearpin_rate");
    </script>
{% endblock %}

{% block scripts %}
<script>
    // 戻るボタンの処理
    document.addEventListener('header-back-clicked', function () {
        location.href = '{{ url_for("home") }}';
    });

    // フォーム送信時にローディングを表示
    document.querySelector('.round-form').addEventListener('submit', function() {
        showLoading('作成中...');
    });
</script>
{% endblock %}